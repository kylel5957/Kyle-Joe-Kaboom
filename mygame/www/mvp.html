<script type="module">

    import kaboom from "https://unpkg.com/kaboom@3000.0.1/dist/kaboom.mjs";

    const k = kaboom()
    setBackground(105, 105, 241);

    //loading sprites
    k.loadSprite("nerd", "sprites/nerd.png")
    k.loadSprite("spike", "sprites/spike.png")
    k.loadSprite("block", "sprites/grassy.png")
    k.loadSprite("pov", "sprites/port2.png")
    k.loadSprite("coin", "sprites/coin.png")

    const SPEED = 400;
    k.setGravity(900);


    const LEVELS = [
        [
            "@                ",
            "            $    ",
            "         /     > ",
            "=  =  =  =  =  = ",
        ],
        [
            " @             $             >  ",
            " ==   =   =    =    =    =   =  ",
            "                                ",
            "                                ",
            "      /  /     $       (   =    ",
            "      =  =  =  =   =   =        ",
        ],
        [
            "              (    =    =     =    =   =   ",
            "@                    $        >           $",
            " =   =   =     =     =    =   =     =     =",
        ],
        [
            "@                             ",
            "  //  //     //   //  $  /    ",
            "===========================   ",
            "                              ",
            "                              ",
            "   >                          ",
            "   ======    =====  ==  ====  ",


        ],
    ]



    function addButton(txt, p, a) {

    const btn = add([
        rect(200, 80, { radius: 10 }),
        pos(p),
        area(),
        scale(1),
        anchor("center"),
    ])

    btn.add([
        text(txt),
        anchor("center"),
        color(0, 0, 0),
    ])

    btn.onClick(a)

    return btn
    }


addButton("Start", vec2(700, 300), () => start())



    scene("game", ({ levelIdx, stageScore, coinScore }) => {

        // Use the level passed, or first level
        const level = addLevel(LEVELS[levelIdx || 0], {
            tileWidth: 64,
            tileHeight: 64,
            pos: vec2(100, 200),
            tiles: {
                "@": () => [
                    sprite("nerd"),
                    area(),
                    body(),
                    scale(0.13),
                    anchor("bot"),
                    "player",
                ],
                "=": () => [
                    sprite("block"),
                    area(),
                    scale(0.15),
                    pos(0, 200),
                    body({ isStatic: true }),
                    anchor("bot"),
                ],

                ">": () => [
                    sprite("pov"),
                    area(),
                    scale (0.15),
                    pos(0, 220),
                    anchor("bot"),
                    "portal",
                ],
                "(": () => [
                    sprite("pov"),
                    area(),
                    anchor("bot"),
                    scale(.15),
                    pos(0, 220),
                    "danger",
                ],
                "/": () => [
                    sprite("spike"),
                    area(),
                    anchor("bot"),
                    pos(0, 220),
                    scale(.2),
                    "danger",
                ],
                "$": () => [
                    sprite("coin"),
                    area(),
                    anchor("bot"),
                    scale(.1),
                    "coin",
                ],
            },
        })

        // Get the player object from tag
        const player = level.get("player")[0]

        // Movements
        onKeyPress("space", () => {
            if (player.isGrounded()) {
                player.jump()
            }
        })

        onKeyDown("left", () => {
            player.move(-SPEED, 0)
        })

        onKeyDown("right", () => {
            player.move(SPEED, 0)
        })

        player.onCollide("danger", () => {
            // player.pos = level.tile2Pos(0, 0)
            // Go to "lose" scene when we hit a "danger"
            go("lose", { stageScore: stageScore })
        })

        // Camera
        player.onUpdate(() => {
		camPos(player.worldPos())
        })

        player.onPhysicsResolve(() => {
            camPos(player.worldPos())
        })

        // Fall death
        player.onUpdate(() => {
            if (player.pos.y >= 600) {
                go("lose", { stageScore: stageScore })
            }
        })

        player.onCollide("danger", () => {
		player.pos = level.tile2Pos(0, 0)
		// play("burp")
		// Go to "lose" scene when we hit a "danger"
		go("lose", { stageScore: stageScore })
	})

	player.onCollide("coin", (coin) => {
		destroy(coin)
		// play("pop")
		coinScore++;
		cScore.text = coinScore;
	})

        // Enter the next level on portal
        player.onCollide("portal", () => {
            stageScore++;
            sScore.text = stageScore;
            if (levelIdx < LEVELS.length - 1) {
                // If there's a next level, go() to the same scene but load the next level
                go("game", {
                    levelIdx: levelIdx + 1,
                    stageScore: stageScore,
                    coinScore:coinScore,
                })
            } else {
                // Otherwise we have reached the end of game, go to "win" scene!
                go("win", { stageScore: stageScore, coinScore: coinScore })
            }
        })

        // Score counter text
        const sScore = add([
            text("Level:" + " " + stageScore),
            pos(12),
            fixed(),
        ])

        const cScore = add([
		text("Coins:" + " " + coinScore),
		pos(15, 60),
        fixed()
	])

    })

    scene("lose", ({ stageScore }) => {
        add([
            text(`You beat ${stageScore} level(s)... Try again!`),
            pos(12),
        ])

        // Press any key to go back
        onKeyPress(start)

    })

    scene("win", ({ stageScore, coinScore }) => {

        add([
            text(`You Won!!!`, {
                width: width(),
            }),
            pos(12),
        ])

        onKeyPress(start)

    })

    function start() {
        // Start with the "game" scene, with initial parameters
        go("game", {
            levelIdx: 0,
            stageScore: 0,
            coinScore: 0,
        })
    }



</script>
